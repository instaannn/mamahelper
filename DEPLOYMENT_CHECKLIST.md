# Чеклист для деплоя на сервер

## ✅ Перед деплоем проверьте:

### 1. Переменные окружения (файл `.env` на сервере)

Убедитесь, что на сервере создан файл `.env` со следующими переменными:

```bash
# Обязательные
TELEGRAM_BOT_TOKEN=your_telegram_bot_token_here
YOOKASSA_SHOP_ID=your_shop_id_here
YOOKASSA_SECRET_KEY=your_secret_key_here

# Опциональные
PROVIDER_TOKEN=your_provider_token_here  # Если используете Telegram Payments
ADMIN_USER_ID=your_telegram_user_id  # Для доступа к статистике

# Webhook (опционально, только если есть публичный HTTPS URL)
YOOKASSA_WEBHOOK_ENABLED=false  # Установите true, если настраиваете webhook
WEBHOOK_HOST=0.0.0.0
WEBHOOK_PORT=8080
YOOKASSA_WEBHOOK_SECRET=your_webhook_secret_key_here
```

### 2. Зависимости

Все зависимости указаны в `requirements.txt`:
- ✅ python-telegram-bot[job-queue]==21.8
- ✅ PyYAML>=6.0
- ✅ pydantic>=2.7,<3.0
- ✅ python-dotenv>=1.0.0
- ✅ aiosqlite>=0.19.0
- ✅ yookassa>=3.0.0

**Дополнительные зависимости не требуются** - webhook сервер использует встроенный `http.server`.

### 3. Docker

Проверьте, что:
- ✅ Dockerfile корректный
- ✅ docker-compose.yml настроен правильно
- ✅ Volume для данных (`./app/data`) настроен

**Если используете webhook**, убедитесь, что порт проброшен:
```yaml
ports:
  - "8080:8080"  # Добавьте в docker-compose.yml, если используете webhook
```

### 4. Структура файлов

Убедитесь, что все файлы на месте:
- ✅ `app/main.py` - основной файл бота
- ✅ `app/storage.py` - работа с БД
- ✅ `app/payments.py` - работа с ЮKassa
- ✅ `app/webhook_handler.py` - обработчик webhook (новый)
- ✅ `app/webhook_server.py` - HTTP сервер для webhook (новый)
- ✅ `app/handlers/` - обработчики команд
- ✅ `requirements.txt` - зависимости

### 5. Права доступа

Убедитесь, что:
- ✅ Бот может создавать файлы в `app/data/` (для БД и логов)
- ✅ Если используете webhook, порт доступен извне

### 6. После деплоя проверьте:

1. **Логи бота:**
   ```bash
   docker compose logs -f bot
   ```
   
   Должны увидеть:
   - ✅ "✅ ЮKassa настроен (БОЕВОЙ/ТЕСТОВЫЙ режим)"
   - ✅ "✅ Периодическая проверка статуса платежей ЮKassa настроена"
   - ✅ "Bot is ready to receive updates"

2. **Если webhook включен:**
   - ✅ "✅ Webhook сервер для ЮKassa запущен в отдельном потоке"
   - ✅ Проверьте доступность: `curl http://your-server:8080/health`

3. **Тестовая оплата:**
   - Создайте тестовый платеж
   - Проверьте логи на наличие сообщений `[PAYMENT]` или `[RETURN]`
   - Убедитесь, что премиум активируется

### 7. Настройка webhook в ЮKassa (опционально, НЕ обязательно!)

**⚠️ ВАЖНО: Webhook НЕ обязателен!** Без него все тоже работает - бот проверяет платежи каждые 5 минут.

**Webhook нужен только если:**
- У вас есть публичный HTTPS URL (домен с SSL-сертификатом)
- Вы хотите мгновенную активацию премиума (вместо ожидания до 5 минут)

**Если у вас НЕТ публичного HTTPS URL:**
- Просто не используйте webhook
- Оставьте `YOOKASSA_WEBHOOK_ENABLED=false` (по умолчанию)
- Все будет работать через периодическую проверку

**Если у вас ЕСТЬ публичный HTTPS URL:**

1. Включите webhook в `.env`:
   ```bash
   YOOKASSA_WEBHOOK_ENABLED=true
   ```

2. Добавьте проброс порта в `docker-compose.yml`:
   ```yaml
   ports:
     - "8080:8080"
   ```

3. Настройте nginx/reverse proxy для проксирования на порт 8080

4. В личном кабинете ЮKassa:
   - Перейдите в "Настройки" → "HTTP-уведомления"
   - Добавьте URL: `https://your-domain.com/webhooks/yookassa`
   - Выберите событие: `payment.succeeded`
   - Сохраните

5. Проверьте логи после оплаты - должны появиться сообщения `[WEBHOOK]`

### 8. Возможные проблемы

**Проблема:** Премиум не активируется после оплаты
- ✅ Проверьте логи на наличие ошибок
- ✅ Убедитесь, что `YOOKASSA_SHOP_ID` и `YOOKASSA_SECRET_KEY` правильные
- ✅ Проверьте, что пользователь возвращается в бот после оплаты (`/start payment_success`)
- ✅ Проверьте логи с префиксом `[PAYMENT]` или `[RETURN]`

**Проблема:** Webhook не работает
- ✅ Убедитесь, что `YOOKASSA_WEBHOOK_ENABLED=true`
- ✅ Проверьте, что порт 8080 доступен извне
- ✅ Проверьте логи на наличие ошибок `[WEBHOOK]`
- ✅ Убедитесь, что URL в личном кабинете ЮKassa правильный

**Проблема:** Ошибки при запуске
- ✅ Проверьте, что все зависимости установлены: `pip install -r requirements.txt`
- ✅ Убедитесь, что файл `.env` существует и содержит все необходимые переменные
- ✅ Проверьте логи Docker: `docker compose logs bot`

## ✅ Код готов к деплою!

Все исправления применены:
- ✅ Использование Decimal вместо float для денежных сумм
- ✅ Асинхронные вызовы через asyncio.to_thread()
- ✅ Подробное логирование всех этапов обработки платежей
- ✅ Правильная обработка статусов платежей (только "succeeded")
- ✅ Webhook поддержка (опционально)
- ✅ Улучшенная обработка возврата пользователя после оплаты
