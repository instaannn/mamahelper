# Улучшения базы данных

## Проблема
SQLite может иметь проблемы с блокировками при высокой нагрузке, особенно при одновременных операциях записи.

## ✅ Решение 1: Оптимизация SQLite (уже применено)

### Что сделано:
- ✅ WAL mode включен (Write-Ahead Logging)
- ✅ Retry логика с экспоненциальной задержкой
- ✅ Timeout увеличен до 30 секунд
- ✅ PRAGMA synchronous=NORMAL (баланс скорости и надежности)
- ✅ Кэш увеличен до 64MB
- ✅ Memory-mapped I/O включен (256MB)
- ✅ Временные таблицы в памяти
- ✅ Внешние ключи включены
- ✅ Создана единая функция `_get_db_connection()` для всех подключений

### Рекомендации для SQLite:
1. **Используйте один процесс бота** - SQLite не предназначен для множественных процессов
2. **Минимизируйте длительные транзакции** - делайте commit как можно чаще
3. **Мониторьте логи** - если ошибки "database is locked" продолжаются, рассмотрите PostgreSQL

## Решение 2: Миграция на PostgreSQL (рекомендуется для продакшена)

PostgreSQL лучше подходит для продакшена с высокой нагрузкой:
- ✅ Нет проблем с блокировками
- ✅ Лучшая производительность при множественных подключениях
- ✅ Более надежная работа
- ✅ Поддержка транзакций и ACID

### Шаги миграции:

1. **Установите зависимости:**
```bash
pip install asyncpg
```

2. **Добавьте в requirements.txt:**
```
asyncpg>=0.29.0
```

3. **Настройте переменные окружения (.env):**
```
DATABASE_URL=postgresql://user:password@localhost:5432/mamahelper
# или для SQLite (текущая):
# DATABASE_TYPE=sqlite
```

4. **Создайте новый файл `app/db.py`** с поддержкой обеих БД

### Преимущества PostgreSQL:
- Нет проблем с блокировками
- Лучшая масштабируемость
- Поддержка репликации
- Лучшая производительность при высокой нагрузке

### Недостатки:
- Требует отдельный сервер БД
- Немного сложнее настройка
- Больше потребление ресурсов

## Рекомендация

Для продакшена с высокой нагрузкой **рекомендуется PostgreSQL**. Для небольших проектов можно остаться на SQLite с оптимизациями.

